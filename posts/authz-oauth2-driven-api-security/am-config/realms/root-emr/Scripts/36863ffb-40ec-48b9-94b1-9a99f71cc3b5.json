{
  "metadata" : {
    "realm" : "/emr",
    "amsterVersion" : "7.1.0",
    "entityType" : "Scripts",
    "entityId" : "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "pathParams" : { }
  },
  "data" : {
    "_id" : "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "name" : "OIDC Claims Script",
    "description" : "Default global script for OIDC claims",
    "script" : "LyoKICogQ29weXJpZ2h0IDIwMTQtMjAyMCBGb3JnZVJvY2sgQVMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQKICoKICogVXNlIG9mIHRoaXMgY29kZSByZXF1aXJlcyBhIGNvbW1lcmNpYWwgc29mdHdhcmUgbGljZW5zZSB3aXRoIEZvcmdlUm9jayBBUy4KICogb3Igd2l0aCBvbmUgb2YgaXRzIGFmZmlsaWF0ZXMuIEFsbCB1c2Ugc2hhbGwgYmUgZXhjbHVzaXZlbHkgc3ViamVjdAogKiB0byBzdWNoIGxpY2Vuc2UgYmV0d2VlbiB0aGUgbGljZW5zZWUgYW5kIEZvcmdlUm9jayBBUy4KICovCmltcG9ydCBjb20uaXBsYW5ldC5zc28uU1NPRXhjZXB0aW9uCmltcG9ydCBjb20uc3VuLmlkZW50aXR5LmlkbS5JZFJlcG9FeGNlcHRpb24KaW1wb3J0IG9yZy5mb3JnZXJvY2sub2F1dGgyLmNvcmUuZXhjZXB0aW9ucy5JbnZhbGlkUmVxdWVzdEV4Y2VwdGlvbgppbXBvcnQgb3JnLmZvcmdlcm9jay5vYXV0aDIuY29yZS5Vc2VySW5mb0NsYWltcwppbXBvcnQgb3JnLmZvcmdlcm9jay5vcGVuaWRjb25uZWN0LkNsYWltCgovKgoqIERlZmluZWQgdmFyaWFibGVzOgoqIGxvZ2dlciAtIGFsd2F5cyBwcmVzZW50cywgdGhlICJPQXV0aDJQcm92aWRlciIgZGVidWcgbG9nZ2VyIGluc3RhbmNlCiogY2xhaW1zIC0gYWx3YXlzIHByZXNlbnQsIGRlZmF1bHQgc2VydmVyIHByb3ZpZGVkIGNsYWltcyAtIE1hcDxTdHJpbmcsIE9iamVjdD4KKiBjbGFpbU9iamVjdHMgLSBhbHdheXMgcHJlc2VudCwgZGVmYXVsdCBzZXJ2ZXIgcHJvdmlkZWQgY2xhaW1zIC0gTGlzdDxDbGFpbT4KKiBzZXNzaW9uIC0gcHJlc2VudCBpZiB0aGUgcmVxdWVzdCBjb250YWlucyB0aGUgc2Vzc2lvbiBjb29raWUsIHRoZSB1c2VyJ3Mgc2Vzc2lvbiBvYmplY3QKKiBpZGVudGl0eSAtIGFsd2F5cyBwcmVzZW50LCB0aGUgaWRlbnRpdHkgb2YgdGhlIHJlc291cmNlIG93bmVyCiogc2NvcGVzIC0gYWx3YXlzIHByZXNlbnQsIHRoZSByZXF1ZXN0ZWQgc2NvcGVzCiogc2NyaXB0TmFtZSAtIGFsd2F5cyBwcmVzZW50LCB0aGUgZGlzcGxheSBuYW1lIG9mIHRoZSBzY3JpcHQKKiByZXF1ZXN0UHJvcGVydGllcyAtIGFsd2F5cyBwcmVzZW50LCBjb250YWlucyBhIG1hcCBvZiByZXF1ZXN0IHByb3BlcnRpZXM6CiogICAgICAgICAgICAgICAgICAgICByZXF1ZXN0VXJpIC0gdGhlIHJlcXVlc3QgVVJJCiogICAgICAgICAgICAgICAgICAgICByZWFsbSAtIHRoZSByZWFsbSB0aGF0IHRoZSByZXF1ZXN0IHJlbGF0ZXMgdG8KKiAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RQYXJhbXMgLSBhIG1hcCBvZiB0aGUgcmVxdWVzdCBwYXJhbXMgYW5kL29yIHBvc3RlZCBkYXRhLiBFYWNoIHZhbHVlIGlzIGEgbGlzdCBvZiBvbmUgb3IKKiAgICAgICAgICAgICAgICAgICAgIG1vcmUgcHJvcGVydGllcy4gUGxlYXNlIG5vdGUgdGhhdCB0aGVzZSBzaG91bGQgYmUgaGFuZGxlZCBpbiBhY2NvcmRhbmNlIHdpdGggT1dBU1AgYmVzdCBwcmFjdGljZXMuCiogY2xpZW50UHJvcGVydGllcyAtIHByZXNlbnQgaWYgdGhlIGNsaWVudCBzcGVjaWZpZWQgaW4gdGhlIHJlcXVlc3Qgd2FzIGlkZW50aWZpZWQsIGNvbnRhaW5zIGEgbWFwIG9mIGNsaWVudAoqICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOgoqICAgICAgICAgICAgICAgICAgICBjbGllbnRJZCAtIHRoZSBjbGllbnQncyBVcmkgZm9yIHRoZSByZXF1ZXN0IGxvY2FsZQoqICAgICAgICAgICAgICAgICAgICBhbGxvd2VkR3JhbnRUeXBlcyAtIGxpc3Qgb2YgdGhlIGFsbG93ZWQgZ3JhbnQgdHlwZXMgKG9yZy5mb3JnZXJvY2sub2F1dGgyLmNvcmUuR3JhbnRUeXBlKQoqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciB0aGUgY2xpZW50CiogICAgICAgICAgICAgICAgICAgIGFsbG93ZWRSZXNwb25zZVR5cGVzIC0gbGlzdCBvZiB0aGUgYWxsb3dlZCByZXNwb25zZSB0eXBlcyBmb3IgdGhlIGNsaWVudAoqICAgICAgICAgICAgICAgICAgICBhbGxvd2VkU2NvcGVzIC0gbGlzdCBvZiB0aGUgYWxsb3dlZCBzY29wZXMgZm9yIHRoZSBjbGllbnQKKiAgICAgICAgICAgICAgICAgICAgY3VzdG9tUHJvcGVydGllcyAtIEEgbWFwIG9mIHRoZSBjdXN0b20gcHJvcGVydGllcyBvZiB0aGUgY2xpZW50LgoqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTGlzdHMgb3IgbWFwcyB3aWxsIGJlIGluY2x1ZGVkIGFzIHN1Yi1tYXBzLCBlLmc6CiogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXN0TWFwW0tleTFdPVZhbHVlMSB3aWxsIGJlIHJldHVybmVkIGFzIHRlc3RtYXAgLT4gS2V5MSAtPiBWYWx1ZTEKKiByZXF1ZXN0ZWRDbGFpbXMgLSBNYXA8U3RyaW5nLCBTZXQ8U3RyaW5nPj4KKiAgICAgICAgICAgICAgICAgIGFsd2F5cyBwcmVzZW50LCBub3QgZW1wdHkgaWYgdGhlIHJlcXVlc3QgY29udGFpbnMgYSBjbGFpbXMgcGFyYW1ldGVyIGFuZCBzZXJ2ZXIgaGFzIGVuYWJsZWQKKiAgICAgICAgICAgICAgICAgIGNsYWltc19wYXJhbWV0ZXJfc3VwcG9ydGVkLCBtYXAgb2YgcmVxdWVzdGVkIGNsYWltcyB0byBwb3NzaWJsZSB2YWx1ZXMsIG90aGVyd2lzZSBlbXB0eSwKKiAgICAgICAgICAgICAgICAgIHJlcXVlc3RlZCBjbGFpbXMgd2l0aCBubyByZXF1ZXN0ZWQgdmFsdWVzIHdpbGwgaGF2ZSBhIGtleSBidXQgbm8gdmFsdWUgaW4gdGhlIG1hcC4gQSBrZXkgd2l0aAoqICAgICAgICAgICAgICAgICAgYSBzaW5nbGUgdmFsdWUgaW4gaXRzIFNldCBpbmRpY2F0ZXMgdGhpcyBpcyB0aGUgb25seSB2YWx1ZSB0aGF0IHNob3VsZCBiZSByZXR1cm5lZC4KKiByZXF1ZXN0ZWRUeXBlZENsYWltcyAtIExpc3Q8Q2xhaW0+CiogICAgICAgICAgICAgICAgICAgICAgIGFsd2F5cyBwcmVzZW50LCBub3QgZW1wdHkgaWYgdGhlIHJlcXVlc3QgY29udGFpbnMgYSBjbGFpbXMgcGFyYW1ldGVyIGFuZCBzZXJ2ZXIgaGFzIGVuYWJsZWQKKiAgICAgICAgICAgICAgICAgICAgICAgY2xhaW1zX3BhcmFtZXRlcl9zdXBwb3J0ZWQsIGxpc3Qgb2YgcmVxdWVzdGVkIGNsYWltcyB3aXRoIGNsYWltIG5hbWUsIHJlcXVlc3RlZCBwb3NzaWJsZSB2YWx1ZXMKKiAgICAgICAgICAgICAgICAgICAgICAgYW5kIGlmIGNsYWltIGlzIGVzc2VudGlhbCwgb3RoZXJ3aXNlIGVtcHR5LAoqICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0ZWQgY2xhaW1zIHdpdGggbm8gcmVxdWVzdGVkIHZhbHVlcyB3aWxsIGhhdmUgYSBjbGFpbSB3aXRoIG5vIHZhbHVlcy4gQSBjbGFpbXMgd2l0aAoqICAgICAgICAgICAgICAgICAgICAgICBhIHNpbmdsZSB2YWx1ZSBpbmRpY2F0ZXMgdGhpcyBpcyB0aGUgb25seSB2YWx1ZSB0aGF0IHNob3VsZCBiZSByZXR1cm5lZC4KKiBjbGFpbXNMb2NhbGVzIC0gdGhlIHZhbHVlcyBmcm9tIHRoZSAnY2xhaW1zX2xvY2FsZXMnIHBhcmFtZXRlciAtIExpc3Q8U3RyaW5nPgoqIFJlcXVpcmVkIHRvIHJldHVybiBhIE1hcCBvZiBjbGFpbXMgdG8gYmUgYWRkZWQgdG8gdGhlIGlkX3Rva2VuIGNsYWltcwoqCiogRXhwZWN0ZWQgcmV0dXJuIHZhbHVlIHN0cnVjdHVyZToKKiBVc2VySW5mb0NsYWltcyB7CiogICAgTWFwPFN0cmluZywgT2JqZWN0PiB2YWx1ZXM7IC8vIFRoZSB2YWx1ZXMgb2YgdGhlIGNsYWltcyBmb3IgdGhlIHVzZXIgaW5mb3JtYXRpb24KKiAgICBNYXA8U3RyaW5nLCBMaXN0PFN0cmluZz4+IGNvbXBvc2l0ZVNjb3BlczsgLy8gTWFwcGluZyBvZiBzY29wZSBuYW1lIHRvIGEgbGlzdCBvZiBjbGFpbSBuYW1lcy4KKiB9CiovCgovLyB1c2VyIHNlc3Npb24gbm90IGd1YXJhbnRlZWQgdG8gYmUgcHJlc2VudApib29sZWFuIHNlc3Npb25QcmVzZW50ID0gc2Vzc2lvbiAhPSBudWxsCgovKgogKiBQdWxscyBmaXJzdCB2YWx1ZSBmcm9tIHVzZXJzIHByb2ZpbGUgYXR0cmlidXRlCiAqCiAqIEBwYXJhbSBjbGFpbSBUaGUgY2xhaW0gb2JqZWN0LgogKiBAcGFyYW0gYXR0ciBUaGUgcHJvZmlsZSBhdHRyaWJ1dGUgbmFtZS4KICovCmRlZiBmcm9tU2V0ID0geyBjbGFpbSwgYXR0ciAtPgogICAgaWYgKGF0dHIgIT0gbnVsbCAmJiBhdHRyLnNpemUoKSA9PSAxKXsKICAgICAgICBhdHRyLml0ZXJhdG9yKCkubmV4dCgpCiAgICB9IGVsc2UgaWYgKGF0dHIgIT0gbnVsbCAmJiBhdHRyLnNpemUoKSA+IDEpewogICAgICAgIGF0dHIKICAgIH0gZWxzZSBpZiAobG9nZ2VyLndhcm5pbmdFbmFibGVkKCkpIHsKICAgICAgICBsb2dnZXIud2FybmluZygiT3BlbkFNU2NvcGVWYWxpZGF0b3IuZ2V0VXNlckluZm8oKTogR290IGFuIGVtcHR5IHJlc3VsdCBmb3IgY2xhaW09JGNsYWltIik7CiAgICB9Cn0KCi8vIC0tLXZ2dnZ2dnZ2dnYtLS0gRVhBTVBMRSBDTEFJTSBBVFRSSUJVVEUgUkVTT0xWRVIgRlVOQ1RJT05TIC0tLXZ2dnZ2dnZ2dnYtLS0KLyoKICogQ2xhaW0gcmVzb2x2ZXIgd2hpY2ggcmVzb2x2ZXMgdGhlIHZhbHVlIG9mIHRoZSBjbGFpbSBmcm9tIGl0cyByZXF1ZXN0ZWQgdmFsdWVzLgogKgogKiBUaGlzIHJlc29sdmVyIHdpbGwgcmV0dXJuIGEgdmFsdWUgaWYgdGhlIGNsYWltIGhhcyBvbmUgcmVxdWVzdGVkIHZhbHVlcywgb3RoZXJ3aXNlIGFuIGV4Y2VwdGlvbiBpcyB0aHJvd24uCiAqLwpkZWZhdWx0Q2xhaW1SZXNvbHZlciA9IHsgY2xhaW0gLT4KICAgIGlmIChjbGFpbS5nZXRWYWx1ZXMoKS5zaXplKCkgPT0gMSkgewogICAgICAgIFsoY2xhaW0uZ2V0TmFtZSgpKTogY2xhaW0uZ2V0VmFsdWVzKCkuaXRlcmF0b3IoKS5uZXh0KCldCiAgICB9IGVsc2UgewogICAgICAgIFs6XQogICAgfQp9CgovKgogKiBDbGFpbSByZXNvbHZlciB3aGljaCByZXNvbHZlcyB0aGUgdmFsdWUgb2YgdGhlIGNsYWltIGJ5IGxvb2tpbmcgdXAgdGhlIHVzZXIncyBwcm9maWxlLgogKgogKiBUaGlzIHJlc29sdmVyIHdpbGwgcmV0dXJuIGEgdmFsdWUgZm9yIHRoZSBjbGFpbSBpZjoKICogIyB0aGUgdXNlcidzIHByb2ZpbGUgYXR0cmlidXRlIGlzIG5vdCBudWxsCiAqICMgQU5EIHRoZSBjbGFpbSBjb250YWlucyBubyByZXF1ZXN0ZWQgdmFsdWVzCiAqICMgT1IgdGhlIGNsYWltIGNvbnRhaW5zIHJlcXVlc3RlZCB2YWx1ZXMgYW5kIHRoZSB2YWx1ZSBmcm9tIHRoZSB1c2VyJ3MgcHJvZmlsZSBpcyBpbiB0aGUgbGlzdCBvZiB2YWx1ZXMKICoKICogSWYgbm8gbWF0Y2ggaXMgZm91bmQgYW4gZXhjZXB0aW9uIGlzIHRocm93bi4KICovCnVzZXJQcm9maWxlQ2xhaW1SZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIGlmIChpZGVudGl0eSAhPSBudWxsKSB7CiAgICAgICAgdXNlclByb2ZpbGVWYWx1ZSA9IGZyb21TZXQoY2xhaW0uZ2V0TmFtZSgpLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgICAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsICYmIChjbGFpbS5nZXRWYWx1ZXMoKSA9PSBudWxsIHx8IGNsYWltLmdldFZhbHVlcygpLmlzRW1wdHkoKSB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5jb250YWlucyh1c2VyUHJvZmlsZVZhbHVlKSkpIHsKICAgICAgICAgICAgcmV0dXJuIFsoY2xhaW0uZ2V0TmFtZSgpKTogdXNlclByb2ZpbGVWYWx1ZV0KICAgICAgICB9CiAgICB9CiAgICBbOl0KfQoKLyoKICogQ2xhaW0gcmVzb2x2ZXIgd2hpY2ggcmVzb2x2ZXMgdGhlIHZhbHVlIG9mIHRoZSBjbGFpbSBvZiB0aGUgdXNlcidzIGFkZHJlc3MuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCByZXR1cm4gYSB2YWx1ZSBmb3IgdGhlIGNsYWltIGlmOgogKiAjIHRoZSB2YWx1ZSBvZiB0aGUgYWRkcmVzcyBpcyBub3QgbnVsbAogKgogKi8KdXNlckFkZHJlc3NDbGFpbVJlc29sdmVyID0geyBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIGlmIChpZGVudGl0eSAhPSBudWxsKSB7CiAgICAgICAgYWRkcmVzc0Zvcm1hdHRlZFZhbHVlID0gZnJvbVNldChjbGFpbS5nZXROYW1lKCksIGlkZW50aXR5LmdldEF0dHJpYnV0ZSgicG9zdGFsYWRkcmVzcyIpKQogICAgICAgIGlmIChhZGRyZXNzRm9ybWF0dGVkVmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgICJmb3JtYXR0ZWQiIDogYWRkcmVzc0Zvcm1hdHRlZFZhbHVlCiAgICAgICAgICAgIF0KICAgICAgICB9CiAgICB9CiAgICBbOl0KfQoKLyoKICogQ2xhaW0gcmVzb2x2ZXIgd2hpY2ggcmVzb2x2ZXMgdGhlIHZhbHVlIG9mIHRoZSBjbGFpbSBieSBsb29raW5nIHVwIHRoZSB1c2VyJ3MgcHJvZmlsZS4KICoKICogVGhpcyByZXNvbHZlciB3aWxsIHJldHVybiBhIHZhbHVlIGZvciB0aGUgY2xhaW0gaWY6CiAqICMgdGhlIHVzZXIncyBwcm9maWxlIGF0dHJpYnV0ZSBpcyBub3QgbnVsbAogKiAjIEFORCB0aGUgY2xhaW0gY29udGFpbnMgbm8gcmVxdWVzdGVkIHZhbHVlcwogKiAjIE9SIHRoZSBjbGFpbSBjb250YWlucyByZXF1ZXN0ZWQgdmFsdWVzIGFuZCB0aGUgdmFsdWUgZnJvbSB0aGUgdXNlcidzIHByb2ZpbGUgaXMgaW4gdGhlIGxpc3Qgb2YgdmFsdWVzCiAqCiAqIElmIHRoZSBjbGFpbSBpcyBlc3NlbnRpYWwgYW5kIG5vIHZhbHVlIGlzIGZvdW5kIGFuIEludmFsaWRSZXF1ZXN0RXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duIGFuZCByZXR1cm5lZCB0byB0aGUgdXNlci4KICogSWYgbm8gbWF0Y2ggaXMgZm91bmQgYW4gZXhjZXB0aW9uIGlzIHRocm93bi4KICovCmVzc2VudGlhbENsYWltUmVzb2x2ZXIgPSB7IGF0dHJpYnV0ZSwgY2xhaW0sIGlkZW50aXR5IC0+CiAgICBpZiAoaWRlbnRpdHkgIT0gbnVsbCkgewogICAgICAgIHVzZXJQcm9maWxlVmFsdWUgPSBmcm9tU2V0KGNsYWltLmdldE5hbWUoKSwgaWRlbnRpdHkuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZSkpCiAgICAgICAgaWYgKGNsYWltLmlzRXNzZW50aWFsKCkgJiYgKHVzZXJQcm9maWxlVmFsdWUgPT0gbnVsbCB8fCB1c2VyUHJvZmlsZVZhbHVlLmlzRW1wdHkoKSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRSZXF1ZXN0RXhjZXB0aW9uKCJDb3VsZCBub3QgcHJvdmlkZSB2YWx1ZSBmb3IgZXNzZW50aWFsIGNsYWltICRjbGFpbSIpCiAgICAgICAgfQogICAgICAgIGlmICh1c2VyUHJvZmlsZVZhbHVlICE9IG51bGwgJiYgKGNsYWltLmdldFZhbHVlcygpID09IG51bGwgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuaXNFbXB0eSgpIHx8IGNsYWltLmdldFZhbHVlcygpLmNvbnRhaW5zKHVzZXJQcm9maWxlVmFsdWUpKSkgewogICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkpOiB1c2VyUHJvZmlsZVZhbHVlXQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBbOl0KfQoKLyoKICogQ2xhaW0gcmVzb2x2ZXIgd2hpY2ggZXhwZWN0cyB0aGUgdXNlcidzIHByb2ZpbGUgYXR0cmlidXRlIHZhbHVlIHRvIGJlIGluIHRoZSBmb2xsb3dpbmcgZm9ybWF0OgogKiAibGFuZ3VhZ2VfdGFnfHZhbHVlX2Zvcl9sYW5ndWFnZSwuLi4iLgogKgogKiBUaGlzIHJlc29sdmVyIHdpbGwgdGFrZSB0aGUgbGlzdCBvZiByZXF1ZXN0ZWQgbGFuZ3VhZ2VzIGZyb20gdGhlICdjbGFpbXNfbG9jYWxlcycgYXV0aG9yaXplIHJlcXVlc3QKICogcGFyYW1ldGVyIGFuZCBhdHRlbXB0IHRvIG1hdGNoIGl0IHRvIGEgdmFsdWUgZnJvbSB0aGUgdXNlcnMnIHByb2ZpbGUgYXR0cmlidXRlLgogKiBJZiBubyBtYXRjaCBpcyBmb3VuZCBhbiBleGNlcHRpb24gaXMgdGhyb3duLgogKi8KY2xhaW1Mb2NhbGVzQ2xhaW1SZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIGlmIChpZGVudGl0eSAhPSBudWxsKSB7CiAgICAgICAgdXNlclByb2ZpbGVWYWx1ZSA9IGZyb21TZXQoY2xhaW0uZ2V0TmFtZSgpLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgICAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIGxvY2FsZVZhbHVlcyA9IHBhcnNlTG9jYWxlQXdhcmVTdHJpbmcodXNlclByb2ZpbGVWYWx1ZSkKICAgICAgICAgICAgbG9jYWxlID0gY2xhaW1zTG9jYWxlcy5maW5kIHsgbG9jYWxlIC0+IGxvY2FsZVZhbHVlcy5jb250YWluc0tleShsb2NhbGUpIH0KICAgICAgICAgICAgaWYgKGxvY2FsZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkpOiBsb2NhbGVWYWx1ZXMuZ2V0KGxvY2FsZSldCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gWzpdCn0KCi8qCiAqIENsYWltIHJlc29sdmVyIHdoaWNoIGV4cGVjdHMgdGhlIHVzZXIncyBwcm9maWxlIGF0dHJpYnV0ZSB2YWx1ZSB0byBiZSBpbiB0aGUgZm9sbG93aW5nIGZvcm1hdDoKICogImxhbmd1YWdlX3RhZ3x2YWx1ZV9mb3JfbGFuZ3VhZ2UsLi4uIi4KICoKICogVGhpcyByZXNvbHZlciB3aWxsIHRha2UgdGhlIGxhbmd1YWdlIHRhZyBzcGVjaWZpZWQgaW4gdGhlIGNsYWltIG9iamVjdCBhbmQgYXR0ZW1wdCB0byBtYXRjaCBpdCB0byBhIHZhbHVlCiAqIGZyb20gdGhlIHVzZXJzJyBwcm9maWxlIGF0dHJpYnV0ZS4gSWYgbm8gbWF0Y2ggaXMgZm91bmQgYW4gZXhjZXB0aW9uIGlzIHRocm93bi4KICovCmxhbmd1YWdlVGFnQ2xhaW1SZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIGlmIChpZGVudGl0eSAhPSBudWxsKSB7CiAgICAgICAgdXNlclByb2ZpbGVWYWx1ZSA9IGZyb21TZXQoY2xhaW0uZ2V0TmFtZSgpLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgICAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIGxvY2FsZVZhbHVlcyA9IHBhcnNlTG9jYWxlQXdhcmVTdHJpbmcodXNlclByb2ZpbGVWYWx1ZSkKICAgICAgICAgICAgaWYgKGNsYWltLmdldExvY2FsZSgpICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChsb2NhbGVWYWx1ZXMuY29udGFpbnNLZXkoY2xhaW0uZ2V0TG9jYWxlKCkpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsoY2xhaW0uZ2V0TmFtZSgpKTogbG9jYWxlVmFsdWVzLmdldChjbGFpbS5nZXRMb2NhbGUoKSldCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVudHJ5ID0gbG9jYWxlVmFsdWVzLmVudHJ5U2V0KCkuaXRlcmF0b3IoKS5uZXh0KCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkgKyAiIyIgKyBlbnRyeS5nZXRLZXkoKSk6IGVudHJ5LmdldFZhbHVlKCldCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbnRyeSA9IGxvY2FsZVZhbHVlcy5lbnRyeVNldCgpLml0ZXJhdG9yKCkubmV4dCgpCiAgICAgICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkpOiBlbnRyeS5nZXRWYWx1ZSgpXQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIFs6XQp9CgovKgogKiBHaXZlbiBhIHN0cmluZyAiZW58RW5nbGlzaCxqcHxKYXBlbmVzZSxmcl9DQXxGcmVuY2ggQ2FuYWRpYW4iIHdpbGwgcmV0dXJuIG1hcCBvZiBsb2NhbGUgLT4gdmFsdWUuCiAqLwpwYXJzZUxvY2FsZUF3YXJlU3RyaW5nID0geyBzIC0+CiAgICByZXR1cm4gcmVzdWx0ID0gcy5zcGxpdCgiLCIpLmNvbGxlY3RFbnRyaWVzIHsgZW50cnkgLT4KICAgICAgICBzcGxpdCA9IGVudHJ5LnNwbGl0KCJcXHwiKQogICAgICAgIFsoc3BsaXRbMF0pOiB2YWx1ZSA9IHNwbGl0WzFdXQogICAgfQp9Ci8vIC0tLV5eXl5eXl5eXl4tLS0gRVhBTVBMRSBDTEFJTSBBVFRSSUJVVEUgUkVTT0xWRVIgRlVOQ1RJT05TIC0tLV5eXl5eXl5eXl4tLS0KCi8vIC0tLS0tLS0tLS0tLS0tIFVQREFURSBUSElTIFRPIENIQU5HRSBDTEFJTSBUTyBBVFRSSUJVVEUgTUFQUElORyBGVU5DVElPTlMgLS0tLS0tLS0tLS0tLS0tCi8qCiAqIExpc3Qgb2YgY2xhaW0gcmVzb2x2ZXIgbWFwcGluZ3MuCiAqLwovLyBbIHtjbGFpbX06IHthdHRyaWJ1dGUgcmV0cmlldmVyfSwgLi4uIF0KY2xhaW1BdHRyaWJ1dGVzID0gWwogICAgICAgICJlbWFpbCI6IHVzZXJQcm9maWxlQ2xhaW1SZXNvbHZlci5jdXJyeSgibWFpbCIpLAogICAgICAgICJhZGRyZXNzIjogeyBjbGFpbSwgaWRlbnRpdHkgLT4gWyAiYWRkcmVzcyIgOiB1c2VyQWRkcmVzc0NsYWltUmVzb2x2ZXIoY2xhaW0sIGlkZW50aXR5KSBdIH0sCiAgICAgICAgInBob25lX251bWJlciI6IHVzZXJQcm9maWxlQ2xhaW1SZXNvbHZlci5jdXJyeSgidGVsZXBob25lbnVtYmVyIiksCiAgICAgICAgImdpdmVuX25hbWUiOiB1c2VyUHJvZmlsZUNsYWltUmVzb2x2ZXIuY3VycnkoImdpdmVubmFtZSIpLAogICAgICAgICJ6b25laW5mbyI6IHVzZXJQcm9maWxlQ2xhaW1SZXNvbHZlci5jdXJyeSgicHJlZmVycmVkdGltZXpvbmUiKSwKICAgICAgICAiZmFtaWx5X25hbWUiOiB1c2VyUHJvZmlsZUNsYWltUmVzb2x2ZXIuY3VycnkoInNuIiksCiAgICAgICAgImxvY2FsZSI6IHVzZXJQcm9maWxlQ2xhaW1SZXNvbHZlci5jdXJyeSgicHJlZmVycmVkbG9jYWxlIiksCiAgICAgICAgIm5hbWUiOiB1c2VyUHJvZmlsZUNsYWltUmVzb2x2ZXIuY3VycnkoImNuIikKXQoKCi8vIC0tLS0tLS0tLS0tLS0tIFVQREFURSBUSElTIFRPIENIQU5HRSBTQ09QRSBUTyBDTEFJTSBNQVBQSU5HUyAtLS0tLS0tLS0tLS0tLQovKgogKiBNYXAgb2Ygc2NvcGVzIHRvIGNsYWltIG9iamVjdHMuCiAqLwovLyB7c2NvcGV9OiBbIHtjbGFpbX0sIC4uLiBdCnNjb3BlQ2xhaW1zTWFwID0gWwogICAgICAgICJlbWFpbCI6IFsgImVtYWlsIiBdLAogICAgICAgICJhZGRyZXNzIjogWyAiYWRkcmVzcyIgXSwKICAgICAgICAicGhvbmUiOiBbICJwaG9uZV9udW1iZXIiIF0sCiAgICAgICAgInByb2ZpbGUiOiBbICJnaXZlbl9uYW1lIiwgInpvbmVpbmZvIiwgImZhbWlseV9uYW1lIiwgImxvY2FsZSIsICJuYW1lIiBdCl0KCgovLyAtLS0tLS0tLS0tLS0tLS0tIFVQREFURSBCRUxPVyBGT1IgQURWQU5DRUQgVVNBR0VTIC0tLS0tLS0tLS0tLS0tLS0tLS0KaWYgKGxvZ2dlci5tZXNzYWdlRW5hYmxlZCgpKSB7CiAgICBzY29wZXMuZmluZEFsbCB7IHMgLT4gISgib3BlbmlkIi5lcXVhbHMocykgfHwgc2NvcGVDbGFpbXNNYXAuY29udGFpbnNLZXkocykpIH0uZWFjaCB7IHMgLT4KICAgICAgICBsb2dnZXIubWVzc2FnZSgiT3BlbkFNU2NvcGVWYWxpZGF0b3IuZ2V0VXNlckluZm8oKTo6TWVzc2FnZTogc2NvcGUgbm90IGJvdW5kIHRvIGNsYWltczogJHMiKQogICAgfQp9CgovKgogKiBDb21wdXRlcyB0aGUgY2xhaW1zIHJldHVybiBrZXkgYW5kIHZhbHVlLiBUaGUga2V5IG1heSBiZSBhIGRpZmZlcmVudCB2YWx1ZSBpZiB0aGUgY2xhaW0gdmFsdWUgaXMgbm90IGluCiAqIHRoZSByZXF1ZXN0ZWQgbGFuZ3VhZ2UuCiAqLwpkZWYgY29tcHV0ZUNsYWltID0geyBjbGFpbSAtPgogICAgdHJ5IHsKICAgICAgICBjbGFpbVJlc29sdmVyID0gY2xhaW1BdHRyaWJ1dGVzLmdldChjbGFpbS5nZXROYW1lKCksIHsgY2xhaW1PYmosIGlkZW50aXR5IC0+IGRlZmF1bHRDbGFpbVJlc29sdmVyKGNsYWltKX0pCiAgICAgICAgY2xhaW1SZXNvbHZlcihjbGFpbSwgaWRlbnRpdHkpCiAgICB9IGNhdGNoIChJZFJlcG9FeGNlcHRpb24gZSkgewogICAgICAgIGlmIChsb2dnZXIud2FybmluZ0VuYWJsZWQoKSkgewogICAgICAgICAgICBsb2dnZXIud2FybmluZygiT3BlbkFNU2NvcGVWYWxpZGF0b3IuZ2V0VXNlckluZm8oKTogVW5hYmxlIHRvIHJldHJpZXZlIGF0dHJpYnV0ZT0kYXR0cmlidXRlIiwgZSk7CiAgICAgICAgfQogICAgfSBjYXRjaCAoU1NPRXhjZXB0aW9uIGUpIHsKICAgICAgICBpZiAobG9nZ2VyLndhcm5pbmdFbmFibGVkKCkpIHsKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk9wZW5BTVNjb3BlVmFsaWRhdG9yLmdldFVzZXJJbmZvKCk6IFVuYWJsZSB0byByZXRyaWV2ZSBhdHRyaWJ1dGU9JGF0dHJpYnV0ZSIsIGUpOwogICAgICAgIH0KICAgIH0KfQoKLyoKICogQ29udmVydHMgcmVxdWVzdGVkIHNjb3BlcyBpbnRvIGNsYWltIG9iamVjdHMgYmFzZWQgb24gdGhlIHNjb3BlIG1hcHBpbmdzIGluIHNjb3BlQ2xhaW1zTWFwLgogKi8KZGVmIGNvbnZlcnRTY29wZVRvQ2xhaW1zID0gewogICAgc2NvcGVzLmZpbmRBbGwgeyBzY29wZSAtPiAib3BlbmlkIiAhPSBzY29wZSAmJiBzY29wZUNsYWltc01hcC5jb250YWluc0tleShzY29wZSkgfS5jb2xsZWN0TWFueSB7IHNjb3BlIC0+CiAgICAgICAgc2NvcGVDbGFpbXNNYXAuZ2V0KHNjb3BlKS5jb2xsZWN0IHsgY2xhaW0gLT4KICAgICAgICAgICAgbmV3IENsYWltKGNsYWltKQogICAgICAgIH0KICAgIH0KfQoKLy8gQ3JlYXRlcyBhIGZ1bGwgbGlzdCBvZiBjbGFpbXMgdG8gcmVzb2x2ZSBmcm9tIHJlcXVlc3RlZCBzY29wZXMsIGNsYWltcyBwcm92aWRlZCBieSBBUyBhbmQgcmVxdWVzdGVkIGNsYWltcwpkZWYgY2xhaW1zVG9SZXNvbHZlID0gY29udmVydFNjb3BlVG9DbGFpbXMoKSArIGNsYWltT2JqZWN0cyArIHJlcXVlc3RlZFR5cGVkQ2xhaW1zCgovLyBDb21wdXRlcyB0aGUgY2xhaW0gcmV0dXJuIGtleSBhbmQgdmFsdWVzIGZvciBhbGwgcmVxdWVzdGVkIGNsYWltcwpjb21wdXRlZENsYWltcyA9IGNsYWltc1RvUmVzb2x2ZS5jb2xsZWN0RW50cmllcygpIHsgY2xhaW0gLT4KICAgIHJlc3VsdCA9IGNvbXB1dGVDbGFpbShjbGFpbSkKfQoKLy8gQ29tcHV0ZXMgY29tcG9zaXRlIHNjb3BlcwpkZWYgY29tcG9zaXRlU2NvcGVzID0gc2NvcGVDbGFpbXNNYXAuZmluZEFsbCB7IHNjb3BlIC0+CiAgICBzY29wZXMuY29udGFpbnMoc2NvcGUua2V5KQp9CgpyZXR1cm4gbmV3IFVzZXJJbmZvQ2xhaW1zKChNYXApY29tcHV0ZWRDbGFpbXMsIChNYXApY29tcG9zaXRlU2NvcGVzKQ==",
    "default" : true,
    "language" : "GROOVY",
    "context" : "OIDC_CLAIMS",
    "createdBy" : "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "creationDate" : 1433147666269,
    "lastModifiedBy" : "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "lastModifiedDate" : 1433147666269
  }
}